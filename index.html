<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <title>–¢–û–í–ê–†–´</title>
</head>
<body>
    <header>
        <nav class="navigation">
            <p>FashionStore</p>
            <a href="http://127.0.0.1:8000/product">–¢–æ–≤–∞—Ä—ã</a>
            <a href="http://127.0.0.1:8000/staff">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
            <a href="http://127.0.0.1:8000/analitic">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
            <a href="http://127.0.0.1:8000/setting">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        </nav>  
    </header>

    <h1>–¢–û–í–ê–†–´</h1>
    <div class="form table-seargch">
        <input type="search" placeholder="–ü–æ–∏—Å–∫">
        <button class="add-product-btn" onclick="window.location.href='http://127.0.0.1:8000/add_product'">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>

        <table class="table products">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th></th>
                </tr>
            </thead>    
            <tbody id="productsTableBody">
            <!-- –°—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
    </table>
            
        
    </div>

        <div id="editModal" class="modal hidden">
  <form id="editForm" class="modal-content">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
    <input type="hidden" name="id">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ: <input type="text" name="name" required></label>
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <input type="text" name="category" required></label>
    <label>–¶–µ–Ω–∞: <input type="number" name="price" step="0.01" required></label>
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <input type="number" name="quantity" required></label>
    <label>–ê—Ä—Ç–∏–∫—É–ª: <input type="text" name="article" required></label>
    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: <input type="text" name="parametrs" required></label>

    <div class="modal-actions">
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </form>
</div>

    <footer>
        <p>(c)FashionStore 2025</p>
    </footer>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                const data = await response.json();
                populateTable(data.products);
                setupSearch();
            } catch (error) {
                showError(error.message);
            }
        });

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã–º–∏
        function populateTable(products) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.price} ‚ÇΩ</td>
                        <td>${product.quantity}</td>
                        <td>
                            <button class="edit-btn" data-id="${product.id}">‚úèÔ∏è</button>
                            <button class="delete-btn" data-id="${product.id}">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
        function setupSearch() {
            const searchInput = document.querySelector('input[type="search"]');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#productsTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.prepend(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        document.body.addEventListener('click', async (event) => {
    const editBtn = event.target.closest('.edit-btn');
    const deleteBtn = event.target.closest('.delete-btn');

    if (editBtn) {
        const row = editBtn.closest('tr');
        openModal({
            id: editBtn.dataset.id,
            name: row.children[0].textContent,
            category: row.children[1].textContent,
            price: parseFloat(row.children[2].textContent),
            quantity: parseInt(row.children[3].textContent),
        });
    }

    if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
            const res = await fetch(`/api/products/${id}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                deleteBtn.closest('tr').remove();
            } else {
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
            }
        }
    }
});

function openModal(product) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');
    for (const key in product) {
        form.elements[key].value = product[key];
    }
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const product = {
        name: form.name.value,
        article: form.article.value,
        category: form.category.value,
        parametrs: form.parametrs.value,
        price: parseFloat(form.price.value),
        quantity: parseInt(form.quantity.value),
    };

    const response = await fetch(`/api/products/${form.id.value}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(product)
    });

    if (response.ok) {
        location.reload(); // –ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É
    } else {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
    }
});

    </script>
</body>
</html>