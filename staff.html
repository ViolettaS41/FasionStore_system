<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <title>–°–û–¢–†–£–î–ù–ò–ö–ò</title>
</head>
<body>
  <header>
    <nav class="navigation">
      <p>FashionStore</p>
      <a href="/product">–¢–æ–≤–∞—Ä—ã</a>
      <a href="/staff">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
      <a href="/analitic">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
      <a href="/setting">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </nav>  
  </header>

  <h1>–°–û–¢–†–£–î–ù–ò–ö–ò</h1>

  <div class="table staff">
    <table>
      <thead>
        <tr>
          <th>–§–ò–û</th>
          <th>–†–æ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ</th>
          <th>–õ–æ–≥–∏–Ω</th>
          <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="staffTableBody">
        <!-- —Å—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç <tr>‚Ä¶</tr> -->
      </tbody>
    </table>
  </div>

  <div id="editModal" class="modal hidden">
  <div class="modal-content">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
    <form id="editForm">
      <input type="hidden" name="id" />
      <label>–§–ò–û: <input type="text" name="full_name" required /></label><br>
      <label>–†–æ–ª—å: <input type="text" name="role" required /></label><br>
      <label>–õ–æ–≥–∏–Ω: <input type="text" name="login" required /></label><br>
      <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å: <input type="text" name="post" required /></label><br>
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>
</div>


  <footer>
    <p>(c)FashionStore 2025</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/staff_table');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');

        const data = await response.json();
        populateTable(data.users);
      } catch (error) {
        showError(error.message);
      }
    });

    function populateTable(users) {
      const tbody = document.getElementById('staffTableBody');
      tbody.innerHTML = '';

      users.forEach(user => {
        const row = `
          <tr>
            <td>${user.full_name}</td>
            <td>${user.role}</td>
            <td>${user.login}</td>
            <td>${user.post}</td>
            <td>
              <button class="edit-btn" data-id="${user.id}">‚úèÔ∏è</button>
              <button class="delete-btn" data-id="${user.id}">üóëÔ∏è</button>
              <button class="more-btn" data-id="${user.id}">‚Ä¶</button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      document.body.prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    document.body.addEventListener('click', async (event) => {
  const editBtn = event.target.closest('.edit-btn');
  const deleteBtn = event.target.closest('.delete-btn');

  if (editBtn) {
    const id = editBtn.dataset.id;
    const row = editBtn.closest('tr');
    openModal({
      id,
      full_name: row.children[0].textContent,
      role: row.children[1].textContent,
      login: row.children[2].textContent,
      post: row.children[3].textContent,
    });
  }

  if (deleteBtn) {
    const id = deleteBtn.dataset.id;
    if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) {
      const response = await fetch(`/api/staff/${id}`, { method: 'DELETE' });
      if (response.ok) {
        deleteBtn.closest('tr').remove();
      } else {
        showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
    }
  }
});

function openModal(user) {
  const modal = document.getElementById('editModal');
  const form = document.getElementById('editForm');
  for (const key in user) {
    form.elements[key].value = user[key];
  }
  modal.classList.remove('hidden');
}

function closeModal() {
  document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const user = {
    id: form.id.value,
    full_name: form.full_name.value,
    role: form.role.value,
    login: form.login.value,
    post: form.post.value
  };

  const response = await fetch(`/api/staff/${user.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(user)
  });

  if (response.ok) {
    location.reload(); // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏
  } else {
    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
  }
});

  </script>
</body>
</html>
